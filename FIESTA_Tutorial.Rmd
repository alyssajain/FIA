---
title: "FIESTA_Tutorial"
author: "Alyssa"
date: "3/14/2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# read in FIESTA package
library(FIESTA)
```

## FIESTA Tutorial

This is a tutorial for using the FIESTA package to analyze FIA data.



##  Read in data from the FIA database

```{r cars}
# get CA tree table
CAtrees <- DBgetCSV("TREE", "California")
              
# get CA condition table
CAconds <- DBgetCSV("COND", "California") 

# get CA plot table
CAplots <- DBgetCSV("PLOT", "California")

# get CA strata data
CAstrata <- DBgetStrata(states = "California",
eval_opts = list(Cur = TRUE))

```
##  Population-level calculations

The FIESTA function modGBpop() calculates population data, including number of plots and conditions, adjustment factors, expansion factors, estimation units, acres per estimation unit 

```{r}
# calculate population data
CApopdat <- modGBpop(popTabs = popTables(cond = CAconds,          # FIA plot/condition data
                                    tree = CAtrees,          # FIA tree data
                                    plt = CAplots),         # FIA plot data
                     popTabIDs = list(cond = "PLT_CN"),             # unique ID of plot in cond
                     pltassgn = CAstrata$pltassgn,                 # plot assignments
                     pltassgnid = "PLT_CN",   

                     unitarea = CAstrata$unitarea,                 # area by estimation units
                     unitvar = CAstrata$unitvar,                         # name of estimation unit variable
                     strata = TRUE,                                 # if using post-stratification
                     stratalut = CAstrata$stratalut,               # strata classes and pixels counts
                     strata_opts = strata_options(getwt = TRUE))    # strata options

```

With the population data, you can calculate the number of conditions by land status

```{r}
# Number of conditions by condition status
CApopdat$condsampcnt

```

Or, you can calculate the acreage per estimation unit

```{r}
# Number of conditions by condition status
head(CApopdat$unitarea)

```
##  Area-level calculations

The FIESTA function modGBarea() calculates area level data. Estimates are generated by estimation unit, then summed to populations (in this case, CA).

```{r}
# calculate area data by forest type
CAareadat_foresttype <- modGBarea(GBpopdat = CApopdat,      
                     landarea = "FOREST",
                     rowvar = "FORTYPCD",
                     sumunits = TRUE) 

# look at estimates 
CAareadat_foresttype$est

# calculate area data by ownership type
CAareadat_owntype <- modGBarea(GBpopdat = CApopdat,      
                     landarea = "FOREST",
                     rowvar = "OWNCD",
                     sumunits = TRUE) 
 
# look at estimates 
CAareadat_owntype$est


# calculate area by forest type and stand size class
CAareadat_foreststand <- modGBarea(GBpopdat = CApopdat,                                     # pop - population calculations for CA,
                     landarea = "FOREST",                                     # est - forest land filter
                     rowvar = "FORTYPCD",                                     # est - row domain
                     colvar = "STDSZCD",                                      # est - column domain
                     sumunits = TRUE,                                         # est - sum estimation units to population
                     returntitle = TRUE,                                      # out - return title information
                     table_opts = table_options(row.FIAname = TRUE,           # table - row domain names
                                                col.FIAname = TRUE,           # table - column domain names
                                                allin1 = TRUE)               # table - 
)

# look at estimates
head(CAareadat_foreststand$est)
```
##  Tree-level calculations

FIESTA's modGBtree(function) generates tree estimates by stratum and domain


```{r}
# calculate the number of live trees by forest type and species for CA
CAlivetrees_foresttype_species <- modGBtree(GBpopdat = CApopdat,             # pop - population calculations
                     landarea = "FOREST",                # est - forest land filter
                     sumunits = TRUE,                    # est - sum estimation units to population
                     estvar = "TPA_UNADJ",               # est - number of trees per acre 
                     estvar.filter = "STATUSCD == 1",    # est - live trees only (STATUSCD == 1)
                     rowvar = "FORTYPCD",                # est - row domain
                     colvar = "SPCD",                    # est - column domain
                     returntitle = TRUE,                 # out - return title information
                     table_opts = table_options(
                       row.FIAname = TRUE,               # est - row domain names
                       col.FIAname = TRUE,               # est - column domain names
                       allin1 = TRUE                     # out - return output with est(pse)
                     ))

# look at estimate and percent sampling error
head(CAlivetrees_foresttype_species$est)

```

# Per-acre calculations

FIESTA's modGBratio function generates per-acre estimates
``` {r}
# calculate the number of live trees per acre by species group and diameter class
CAlivetpa_species_dia <- modGBratio(GBpopdat = CApopdat,          # pop - population calculations
                       landarea = "FOREST",                 # est - forest land filter
                       sumunits = TRUE,                     # est - sum estimation units to population
                       estvarn = "TPA_UNADJ",               # est - number of trees per acre, numerator 
                       estvarn.filter = "STATUSCD == 1",    # est - live trees only, numerator
                       rowvar = "SPGRPCD",                  # est - row domain
                       colvar = "STDSZCD",                 # est - column domain
                       returntitle = TRUE,                  # out - return title information
                       table_opts = list(
                         row.FIAname = TRUE,                # est - row domain names
                         allin1 = TRUE                      # out - return output with est(pse)
                       ))                     # out - return output with est(pse)
                       

# look at estimate table
head(CAlivetpa_species_dia$est)


``` 

To see what other variables are available to use in estimates:

```{r}
# look at variables
names(estvarn)
```

